###### 调用函数的方式

```
source("代码\\myfunctions.r")
```

在 r 的脚本前面先运行这个路径文件，就可以像调用 r 包里面的函数一样调用自编函数了

`代码\\myfunctions.r`这个路径需要替换为自己函数脚本的路径

###### 偏相关分析结果表格

1. Adjusted p-value 为 fdr 校正的 p 值，用的是 BH 方法

![1742909846818](image/自编函数说明/1742909846818.png)

###### 回归循环的表格（包含二元 logistic 回归和线性回归，自变量必须为连续型变量或因子型变量）

1. bacterium 就是暴露变量，可以自行更改变量名
2. phenotype 就是结局变量，可以自行更改变量名
3. FDR_p 是用 BH 方法校正的 p 值
4. FDR 校正是对 logistic 回归的结果和线性回归的结果分别校正的
5. 该函数自动根据因变量是 factor 还是 numeric 分别进行 logistic 回归和一般线性回归；最后生成包含 logistic 回归结果的表格，线性回归的表格，两种回归合并后的表格的列表。
6. logistic 回归的统计量为 z，一般线性回归的统计量为 t

![1742909950476](image/自编函数说明/1742909950476.png)

# rarefy_transform_gut_microbiota 函数详细说明

## 函数简介

`rarefy_transform_gut_microbiota`是一个用于肠道菌群丰度表预处理的 R 函数。其主要功能包括：

- 过滤掉总绝对丰度低于阈值（如 1000）的样本
- 抽平（rarefaction）：将每个样本的测序深度统一到最小值
- 计算相对丰度
- 根据相对丰度和检出率进行菌种筛选
- 对数据进行对数变换与标准化（z-score）

该函数适用于下游多种统计分析和可视化的准备工作，如回归、聚类、主成分分析等。

---

## 参数说明

| 参数名                | 类型       | 说明                                       | 默认值 |
| --------------------- | ---------- | ------------------------------------------ | ------ |
| `df_microbiota`       | data.frame | 肠道菌群绝对丰度表，行为样本，列为菌种     | 必需   |
| `sample_id_col`       | 字符串     | 样本 ID 所在列的列名                       | 必需   |
| `rel_abund_threshold` | 数值       | 平均相对丰度过滤阈值，低于此值的菌被剔除   | 0.0001 |
| `occ_threshold`       | 数值       | 最低检出比例（如 0.1 代表 ≥10%样本中检出） | 0.1    |
| `log_add`             | 数值       | 对数变换常数，避免 log(0)                  | 1e-4   |
| `seed`                | 数值       | 随机种子，保证结果可复现                   | 123    |

---

## 处理流程

1. **样本过滤**首先过滤掉总绝对丰度（所有菌丰度之和）低于 1000 的样本，减少极端低测序深度样本对后续分析的不良影响。
2. **抽平（rarefaction）**使用 `vegan::rrarefy`函数，将每个样本的总 reads 数统一为剩余样本中的最小值，消除测序深度差异。
3. **去除全为 0 的菌种**删除所有样本中丰度都为 0 的菌种，减少冗余数据。
4. **计算相对丰度**每个样本的每个菌种丰度除以该样本总丰度，得到标准化的相对丰度。
5. **菌种筛选**

   - 剔除平均相对丰度低于 `rel_abund_threshold`的菌种
   - 剔除检出率（非零比例）低于 `occ_threshold`的菌种

6. **对数变换与标准化**

   - 相对丰度加上 `log_add`常数后取对数，缓解零膨胀和极端值影响
   - 用 `scale()`标准化（z-score），便于后续统计分析

7. **结果输出**返回一个列表，包括：

   - `absolute`：抽平后绝对丰度表
   - `relative`：筛选后的相对丰度表
   - `transformed`：对数化并标准化后的表

---

## 返回值说明

返回一个包含以下元素的列表：

- **absolute**：抽平并筛选后的绝对丰度表（行为样本，列为菌种）
- **relative**：筛选后的相对丰度表
- **transformed**：对数化+标准化后的表，适合下游分析

---

## 代码片段

```r
rarefy_transform_gut_microbiota <- function(df_microbiota,
                                            sample_id_col,
                                            rel_abund_threshold = 0.0001,
                                            occ_threshold = 0.1,
                                            log_add = 1e-4,
                                            seed = 123) {
    if (!requireNamespace("vegan", quietly = TRUE)) {
        stop("Please install the 'vegan' package.")
    }
    set.seed(seed)
    # 以样本ID设置行名，并移除ID列
    rownames(df_microbiota) <- df_microbiota[[sample_id_col]]
    df_microbiota <- df_microbiota[, setdiff(names(df_microbiota), sample_id_col), drop = FALSE]
    # 先过滤：去除总绝对丰度低于1000的样本
    keep_samples <- rowSums(df_microbiota) >= 1000
    df_microbiota <- df_microbiota[keep_samples, , drop = FALSE]
    # 检查类型
    if (!all(sapply(df_microbiota, is.numeric))) stop("All columns except sample ID must be numeric!")
    # 按样本稀释到所有样本最小reads数
    min_depth <- min(rowSums(df_microbiota))
    df_rarefied <- vegan::rrarefy(df_microbiota, sample = min_depth)
    # 移除全为0的菌
    df_abs <- df_rarefied[, colSums(df_rarefied) > 0, drop = FALSE]
    # 计算相对丰度（每行/行和，行为样本，列为菌）
    df_rel <- sweep(df_abs, 1, rowSums(df_abs), FUN = "/")
    # 按平均相对丰度筛选
    keep1 <- colMeans(df_rel) > rel_abund_threshold
    df_rel <- df_rel[, keep1, drop = FALSE]
    # 按出现频率筛选
    keep2 <- colSums(df_rel > 0) / nrow(df_rel) > occ_threshold
    df_rel <- df_rel[, keep2, drop = FALSE]
    # 匹配绝对丰度
    df_abs <- df_abs[, colnames(df_rel), drop = FALSE]
    # 对数变换+标准化
    df_log <- log(df_rel + log_add)
    df_trans <- scale(df_log)
    # 返回
    list(
        absolute = df_abs,
        relative = df_rel,
        transformed = df_trans
    )
}
```

---

## 使用示例

### 示例 1：基础用法

```r
library(vegan)
# 假设microbe_df为原始肠道菌群丰度表，SampleID为样本ID列
result <- rarefy_transform_gut_microbiota(
    df_microbiota = microbe_df,
    sample_id_col = "SampleID"
)
# 查看返回结果
abs_df <- result$absolute         # 稀释后绝对丰度
rel_df <- result$relative         # 相对丰度
trans_df <- result$transformed    # 对数标准化后的表
```

### 示例 2：自定义阈值

```r
result2 <- rarefy_transform_gut_microbiota(
    df_microbiota = microbe_df,
    sample_id_col = "SampleID",
    rel_abund_threshold = 0.001,   # 只保留平均相对丰度大于0.1%的菌
    occ_threshold = 0.2,           # 只保留在20%以上样本中检出的菌
    log_add = 1e-5,                # 更小的对数加数
    seed = 42                      # 指定随机种子
)
```

---

## 注意事项

- 输入数据必须为**行为样本**，列为各菌种，且样本 ID 列需指定。
- 建议先检查样本总 reads 分布，合理设置过滤阈值。
- 需提前安装 `vegan`包：`install.packages("vegan")`
- 筛选参数可根据数据与分析需求调整。

---

## 典型应用场景

- 微生物多样性、群落结构分析前的数据预处理
- 回归、机器学习等定量分析前的特征标准化
- 微生物组学数据与表型/临床数据的联合分析

---
# R函数文档：多组小提琴图+Kruskal-Wallis+Dunn检验批量绘制

## 目录
- [1. 函数概述](#1-函数概述)
- [2. 依赖包](#2-依赖包)
- [3. 主函数参数说明](#3-主函数参数说明)
- [4. 详细功能解释](#4-详细功能解释)
- [5. 返回值](#5-返回值)
- [6. 批量绘图函数说明](#6-批量绘图函数说明)
- [7. 使用示例](#7-使用示例)

---

## 1. 函数概述

本代码包含两个主要R函数，适用于多分类分组变量的小提琴图统计可视化，并自动进行Kruskal-Wallis整体检验及Dunn两两多重比较，并在图中以星号标注显著性。还提供了批量绘制多个变量组合的便捷函数。

- `plot_violin_kruskal_dunn()`：绘制单组多分类分组的小提琴+箱线图，添加整体及两两检验显著性。
- `multi_violin_kruskal_gridExtra()`：对多组变量组合批量绘制并自动输出pdf。

---

## 2. 依赖包

需要以下R包（请确保已安装）：

- `ggplot2`：绘图
- `FSA`：进行Dunn检验
- `ggsignif`：添加显著性标注
- `scales`：配色
- `gridExtra`：多图拼接/输出

---

## 3. 主函数参数说明

### `plot_violin_kruskal_dunn(data, xvar, yvar, fill_colors = NULL, text_size = 12)`

| 参数            | 类型        | 说明                                                         |
|-----------------|-------------|--------------------------------------------------------------|
| `data`          | data.frame  | 包含分组和数值变量的数据框                                   |
| `xvar`          | character   | x轴分组变量名（多分类）                                      |
| `yvar`          | character   | y轴变量名                                                    |
| `fill_colors`   | character[] | 分组的填充颜色向量，默认自动配色                            |
| `text_size`     | numeric     | 文字、星号等元素的字号，默认12                               |

---

## 4. 详细功能解释

### 4.1 分组与配色

- 自动检测`xvar`分组水平数量，若未指定`fill_colors`，自动采用`scales::hue_pal()`生成配色。

### 4.2 统计分析

- **Kruskal-Wallis检验**：对整体分组差异进行非参数检验，返回p值。
- **Dunn检验**：对各组两两比较，采用`FSA::dunnTest`，多重校正方法为`bh`（Benjamini-Hochberg）。
- 两两比较结果以星号（***, **, *, ns）判别显著性。

### 4.3 绘图细节

- 主体为小提琴图+箱线图叠加，分组填充颜色可定制。
- 显著性横线自动堆叠避免重叠，并在两组间加注星号。
- 图上方居中标注整体Kruskal-Wallis检验p值。

### 4.4 主要图层说明

- `geom_violin`：小提琴图，展示分布
- `geom_boxplot`：箱线图，辅助显示中位数、四分位数
- `geom_segment`/`annotate`：自动添加两两比较显著性横线与星号
- `scale_fill_manual`：自定义分组颜色

---

## 5. 返回值

- 返回`ggplot`对象，可直接`print()`或进一步调整。

---

## 6. 批量绘图函数说明

### `multi_violin_kruskal_gridExtra(data, x_vars, y_vars, ...)`

| 参数        | 类型        | 说明                                                   |
|-------------|-------------|--------------------------------------------------------|
| `data`      | data.frame  | 数据框，包含所有分组变量和y变量                        |
| `x_vars`    | character[] | 需分组绘图的变量名列表（如多个分组变量）                |
| `y_vars`    | character[] | 待分析的y变量名列表                                    |
| `plot_fun`  | function    | 单图绘制函数，默认`plot_violin_kruskal_dunn`           |
| `out_dir`   | character   | 输出pdf文件的目录                                      |
| `out_prefix`| character   | 输出文件名前缀                                         |
| `ncol`      | integer     | 每页拼图的列数，默认2                                  |
| `width`     | numeric     | 输出pdf宽度（单位inch）                                |
| `height`    | numeric     | 输出pdf高度                                            |
| `file_ext`  | character   | 输出文件扩展名，默认`.pdf`                             |

#### 功能

- 对每个`x_var`，对所有`y_vars`批量绘图并拼接成一页，按`ncol`排列，自动保存pdf文件，返回所有子图对象和输出路径。

---

## 7. 使用示例

```r
# 假设df为数据框，"Group"为多分类分组变量，"Value1", "Value2"为y变量
# 单图示例
p <- plot_violin_kruskal_dunn(df, xvar = "Group", yvar = "Value1")
print(p)

# 批量输出所有分组和多个y变量的组合
multi_violin_kruskal_gridExtra(
  data = df,
  x_vars = c("Group1", "Group2"),
  y_vars = c("Value1", "Value2", "Value3"),
  out_dir = "result/violin/",
  out_prefix = "myplot_",
  ncol = 2,
  width = 12,
  height = 8
)
```

---

## 备注

- 若分组数较多，建议适当调整`text_size`，或修改`y_gap`的比例防止标注重叠。
- Dunn检验采用`FSA`包，确保已安装且加载。
- 若需更复杂的显著性连线显示方式，可进一步自定义代码中的显著性注释部分。

---